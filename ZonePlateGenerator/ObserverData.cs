using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace ZonePlateGenerator
{
    class ObserverData
    {
        private static readonly double[] xvals = { 
            0.00012990, 0.00014585, 0.00016380, 0.00018400, 0.00020669, 0.00023210, 0.00026073, 0.00029308, 0.00032939, 0.00036991, 
            0.00041490, 0.00046416, 0.00051899, 0.00058185, 0.00065523, 0.00074160, 0.00084503, 0.00096453, 0.00109495, 0.00123115, 
            0.00136800, 0.00150205, 0.00164233, 0.00180238, 0.00199576, 0.00223600, 0.00253539, 0.00289260, 0.00330083, 0.00375324, 
            0.00424300, 0.00476239, 0.00533005, 0.00597871, 0.00674112, 0.00765000, 0.00875137, 0.01002888, 0.01142170, 0.01286901, 
            0.01431000, 0.01570443, 0.01714744, 0.01878122, 0.02074801, 0.02319000, 0.02620736, 0.02978248, 0.03388092, 0.03846824, 
            0.04351000, 0.04899560, 0.05502260, 0.06171880, 0.06921200, 0.07763000, 0.08695811, 0.09717672, 0.10840630, 0.12076720, 
            0.13438000, 0.14935820, 0.16539570, 0.18198310, 0.19861100, 0.21477000, 0.23018680, 0.24487970, 0.25877730, 0.27180790, 
            0.28390000, 0.29494380, 0.30489650, 0.31378730, 0.32164540, 0.32850000, 0.33435130, 0.33921010, 0.34312130, 0.34612960, 
            0.34828000, 0.34959990, 0.35014740, 0.35001300, 0.34928700, 0.34806000, 0.34637330, 0.34426240, 0.34180880, 0.33909410, 
            0.33620000, 0.33319770, 0.33004110, 0.32663570, 0.32288680, 0.31870000, 0.31402510, 0.30888400, 0.30329040, 0.29725790, 
            0.29080000, 0.28397010, 0.27672140, 0.26891780, 0.26042270, 0.25110000, 0.24084750, 0.22985120, 0.21840720, 0.20681150, 
            0.19536000, 0.18421360, 0.17332730, 0.16268810, 0.15228330, 0.14210000, 0.13217860, 0.12256960, 0.11327520, 0.10429790, 
            0.09564000, 0.08729955, 0.07930804, 0.07171776, 0.06458099, 0.05795001, 0.05186211, 0.04628152, 0.04115088, 0.03641283, 
            0.03201000, 0.02791720, 0.02414440, 0.02068700, 0.01754040, 0.01470000, 0.01216179, 0.00991996, 0.00796724, 0.00629635, 
            0.00490000, 0.00377717, 0.00294532, 0.00242488, 0.00223629, 0.00240000, 0.00292552, 0.00383656, 0.00517484, 0.00698208, 
            0.00930000, 0.01214949, 0.01553588, 0.01947752, 0.02399277, 0.02910000, 0.03481485, 0.04112016, 0.04798504, 0.05537861, 
            0.06327000, 0.07163501, 0.08046224, 0.08973996, 0.09945645, 0.10960000, 0.12016740, 0.13111450, 0.14236790, 0.15385420, 
            0.16550000, 0.17725710, 0.18914000, 0.20116940, 0.21336580, 0.22574990, 0.23832090, 0.25106680, 0.26399220, 0.27710170, 
            0.29040000, 0.30389120, 0.31757260, 0.33143840, 0.34548280, 0.35970000, 0.37408390, 0.38863960, 0.40337840, 0.41831150, 
            0.43344990, 0.44879530, 0.46433600, 0.48006400, 0.49597130, 0.51205010, 0.52829590, 0.54469160, 0.56120940, 0.57782150, 
            0.59450000, 0.61122090, 0.62797580, 0.64476020, 0.66156970, 0.67840000, 0.69523920, 0.71205860, 0.72882840, 0.74551880, 
            0.76210000, 0.77854320, 0.79482560, 0.81092640, 0.82682480, 0.84250000, 0.85793250, 0.87308160, 0.88789440, 0.90231810, 
            0.91630000, 0.92979950, 0.94279840, 0.95527760, 0.96721790, 0.97860000, 0.98938560, 0.99954880, 1.00908920, 1.01800640, 
            1.02630000, 1.03398270, 1.04098600, 1.04718800, 1.05246670, 1.05670000, 1.05979440, 1.06179920, 1.06280680, 1.06290960, 
            1.06220000, 1.06073520, 1.05844360, 1.05522440, 1.05097680, 1.04560000, 1.03903690, 1.03136080, 1.02266620, 1.01304770, 
            1.00260000, 0.99136750, 0.97933140, 0.96649160, 0.95284790, 0.93840000, 0.92319400, 0.90724400, 0.89050200, 0.87292000, 
            0.85444990, 0.83508400, 0.81494600, 0.79418600, 0.77295400, 0.75140000, 0.72958360, 0.70758880, 0.68560220, 0.66381040, 
            0.64240000, 0.62151490, 0.60111380, 0.58110520, 0.56139770, 0.54190000, 0.52259950, 0.50354640, 0.48474360, 0.46619390, 
            0.44790000, 0.42986130, 0.41209800, 0.39464400, 0.37753330, 0.36080000, 0.34445630, 0.32851680, 0.31301920, 0.29800110, 
            0.28350000, 0.26954480, 0.25611840, 0.24318960, 0.23072720, 0.21870000, 0.20709710, 0.19592320, 0.18517080, 0.17483230, 
            0.16490000, 0.15536670, 0.14623000, 0.13749000, 0.12914670, 0.12120000, 0.11363970, 0.10646500, 0.09969044, 0.09333061, 
            0.08740000, 0.08190096, 0.07680428, 0.07207712, 0.06768664, 0.06360000, 0.05980685, 0.05628216, 0.05297104, 0.04981861, 
            0.04677000, 0.04378405, 0.04087536, 0.03807264, 0.03540461, 0.03290000, 0.03056419, 0.02838056, 0.02634484, 0.02445275, 
            0.02270000, 0.02108429, 0.01959988, 0.01823732, 0.01698717, 0.01584000, 0.01479064, 0.01383132, 0.01294868, 0.01212920, 
            0.01135916, 0.01062935, 0.00993885, 0.00928842, 0.00867885, 0.00811092, 0.00758239, 0.00708875, 0.00662731, 0.00619541, 
            0.00579035, 0.00540983, 0.00505258, 0.00471751, 0.00440351, 0.00410946, 0.00383391, 0.00357575, 0.00333434, 0.00310908, 
            0.00289933, 0.00270435, 0.00252302, 0.00235417, 0.00219662, 0.00204919, 0.00191096, 0.00178144, 0.00166011, 0.00154646, 
            0.00143997, 0.00134004, 0.00124628, 0.00115847, 0.00107643, 0.00099995, 0.00092874, 0.00086243, 0.00080075, 0.00074340, 
            0.00069008, 0.00064052, 0.00059450, 0.00055186, 0.00051243, 0.00047602, 0.00044245, 0.00041151, 0.00038298, 0.00035665, 
            0.00033230, 0.00030976, 0.00028889, 0.00026954, 0.00025157, 0.00023483, 0.00021917, 0.00020453, 0.00019084, 0.00017807, 
            0.00016615, 0.00015502, 0.00014462, 0.00013491, 0.00012585, 0.00011741, 0.00010955, 0.00010222, 0.00009539, 0.00008902, 
            0.00008308, 0.00007751, 0.00007231, 0.00006746, 0.00006293, 0.00005871, 0.00005477, 0.00005110, 0.00004768, 0.00004449, 
            0.00004151, 0.00003873, 0.00003614, 0.00003372, 0.00003146, 0.00002935, 0.00002738, 0.00002552, 0.00002379, 0.00002218, 
            0.00002067, 0.00001927, 0.00001797, 0.00001675, 0.00001562, 0.00001456, 0.00001357, 0.00001265, 0.00001180, 0.00001100, 
            0.00001025, 0.00000956, 0.00000891, 0.00000831, 0.00000775, 0.00000722, 0.00000673, 0.00000628, 0.00000585, 0.00000546, 
            0.00000509, 0.00000474, 0.00000442, 0.00000412, 0.00000384, 0.00000358, 0.00000334, 0.00000311, 0.00000290, 0.00000271, 
            0.00000252, 0.00000235, 0.00000219, 0.00000204, 0.00000191, 0.00000178, 0.00000166, 0.00000154, 0.00000144, 0.00000134, 
            0.00000125
        };

        private static readonly double[] yvals = { 
            0.00000392, 0.00000439, 0.00000493, 0.00000553, 0.00000621, 0.00000697, 0.00000781, 0.00000877, 0.00000984, 0.00001104, 
            0.00001239, 0.00001389, 0.00001556, 0.00001744, 0.00001958, 0.00002202, 0.00002484, 0.00002804, 0.00003153, 0.00003522, 
            0.00003900, 0.00004283, 0.00004691, 0.00005159, 0.00005718, 0.00006400, 0.00007234, 0.00008221, 0.00009351, 0.00010614, 
            0.00012000, 0.00013498, 0.00015149, 0.00017021, 0.00019182, 0.00021700, 0.00024691, 0.00028124, 0.00031852, 0.00035727, 
            0.00039600, 0.00043371, 0.00047302, 0.00051788, 0.00057222, 0.00064000, 0.00072456, 0.00082550, 0.00094116, 0.00106988, 
            0.00121000, 0.00136209, 0.00153075, 0.00172037, 0.00193532, 0.00218000, 0.00245480, 0.00276400, 0.00311780, 0.00352640, 
            0.00400000, 0.00454624, 0.00515932, 0.00582928, 0.00654616, 0.00730000, 0.00808651, 0.00890872, 0.00976768, 0.01066443, 
            0.01160000, 0.01257317, 0.01358272, 0.01462968, 0.01571509, 0.01684000, 0.01800736, 0.01921448, 0.02045392, 0.02171824, 
            0.02300000, 0.02429461, 0.02561024, 0.02695857, 0.02835125, 0.02980000, 0.03131083, 0.03288368, 0.03452112, 0.03622571, 
            0.03800000, 0.03984667, 0.04176800, 0.04376600, 0.04584267, 0.04800000, 0.05024368, 0.05257304, 0.05498056, 0.05745872, 
            0.06000000, 0.06260197, 0.06527752, 0.06804208, 0.07091109, 0.07390000, 0.07701600, 0.08026640, 0.08366680, 0.08723280, 
            0.09098000, 0.09491755, 0.09904584, 0.10336740, 0.10788460, 0.11260000, 0.11753200, 0.12267440, 0.12799280, 0.13345280, 
            0.13902000, 0.14467640, 0.15046930, 0.15646190, 0.16271770, 0.16930000, 0.17624310, 0.18355810, 0.19127350, 0.19941800, 
            0.20802000, 0.21711990, 0.22673450, 0.23685710, 0.24748120, 0.25860000, 0.27018490, 0.28229390, 0.29505050, 0.30857800, 
            0.32300000, 0.33840210, 0.35468580, 0.37169860, 0.38928750, 0.40730000, 0.42562990, 0.44430960, 0.46339440, 0.48293950, 
            0.50300000, 0.52356930, 0.54451200, 0.56569000, 0.58696530, 0.60820000, 0.62934560, 0.65030680, 0.67087520, 0.69084240, 
            0.71000000, 0.72818520, 0.74546360, 0.76196940, 0.77783680, 0.79320000, 0.80811040, 0.82249620, 0.83630680, 0.84949160, 
            0.86200000, 0.87381080, 0.88496240, 0.89549360, 0.90544320, 0.91485010, 0.92373480, 0.93209240, 0.93992260, 0.94722520, 
            0.95400000, 0.96025610, 0.96600740, 0.97126060, 0.97602250, 0.98030000, 0.98409240, 0.98741820, 0.99031280, 0.99281160, 
            0.99495010, 0.99671080, 0.99809830, 0.99911200, 0.99974820, 1.00000000, 0.99985670, 0.99930460, 0.99832550, 0.99689870, 
            0.99500000, 0.99260050, 0.98974260, 0.98644440, 0.98272410, 0.97860000, 0.97408370, 0.96917120, 0.96385680, 0.95813490, 
            0.95200000, 0.94545040, 0.93849920, 0.93116280, 0.92345760, 0.91540000, 0.90700640, 0.89827720, 0.88920480, 0.87978160, 
            0.87000000, 0.85986130, 0.84939200, 0.83862200, 0.82758130, 0.81630000, 0.80479470, 0.79308200, 0.78119200, 0.76915470, 
            0.75700000, 0.74475410, 0.73242240, 0.72000360, 0.70749650, 0.69490000, 0.68221920, 0.66947160, 0.65667440, 0.64384480, 
            0.63100000, 0.61815550, 0.60531440, 0.59247560, 0.57963790, 0.56680000, 0.55396110, 0.54113720, 0.52835280, 0.51563230, 
            0.50300000, 0.49046880, 0.47803040, 0.46567760, 0.45340320, 0.44120000, 0.42908000, 0.41703600, 0.40503200, 0.39303200, 
            0.38100000, 0.36891840, 0.35682720, 0.34477680, 0.33281760, 0.32100000, 0.30933810, 0.29785040, 0.28659360, 0.27562450, 
            0.26500000, 0.25476320, 0.24488960, 0.23533440, 0.22605280, 0.21700000, 0.20816160, 0.19954880, 0.19115520, 0.18297440, 
            0.17500000, 0.16722350, 0.15964640, 0.15227760, 0.14512590, 0.13820000, 0.13150030, 0.12502480, 0.11877920, 0.11276910, 
            0.10700000, 0.10147620, 0.09618864, 0.09112296, 0.08626485, 0.08160000, 0.07712064, 0.07282552, 0.06871008, 0.06476976, 
            0.06100000, 0.05739621, 0.05395504, 0.05067376, 0.04754965, 0.04458000, 0.04175872, 0.03908496, 0.03656384, 0.03420048, 
            0.03200000, 0.02996261, 0.02807664, 0.02632936, 0.02470805, 0.02320000, 0.02180077, 0.02050112, 0.01928108, 0.01812069, 
            0.01700000, 0.01590379, 0.01483718, 0.01381068, 0.01283478, 0.01192000, 0.01106831, 0.01027339, 0.00953331, 0.00884616, 
            0.00821000, 0.00762378, 0.00708542, 0.00659148, 0.00613849, 0.00572300, 0.00534306, 0.00499580, 0.00467640, 0.00438008, 
            0.00410200, 0.00383845, 0.00358910, 0.00335422, 0.00313409, 0.00292900, 0.00273814, 0.00255988, 0.00239324, 0.00223728, 
            0.00209100, 0.00195359, 0.00182458, 0.00170358, 0.00159019, 0.00148400, 0.00138450, 0.00129127, 0.00120409, 0.00112274, 
            0.00104700, 0.00097659, 0.00091111, 0.00085013, 0.00079324, 0.00074000, 0.00069008, 0.00064331, 0.00059950, 0.00055845, 
            0.00052000, 0.00048391, 0.00045005, 0.00041835, 0.00038872, 0.00036110, 0.00033538, 0.00031144, 0.00028917, 0.00026845, 
            0.00024920, 0.00023130, 0.00021469, 0.00019929, 0.00018505, 0.00017190, 0.00015978, 0.00014860, 0.00013830, 0.00012879, 
            0.00012000, 0.00011186, 0.00010432, 0.00009734, 0.00009085, 0.00008480, 0.00007915, 0.00007386, 0.00006892, 0.00006430, 
            0.00006000, 0.00005598, 0.00005223, 0.00004872, 0.00004545, 0.00004240, 0.00003956, 0.00003692, 0.00003445, 0.00003215, 
            0.00003000, 0.00002799, 0.00002611, 0.00002436, 0.00002272, 0.00002120, 0.00001978, 0.00001845, 0.00001722, 0.00001606, 
            0.00001499, 0.00001399, 0.00001305, 0.00001218, 0.00001136, 0.00001060, 0.00000989, 0.00000922, 0.00000859, 0.00000801, 
            0.00000747, 0.00000696, 0.00000649, 0.00000605, 0.00000564, 0.00000526, 0.00000490, 0.00000457, 0.00000426, 0.00000397, 
            0.00000370, 0.00000345, 0.00000322, 0.00000300, 0.00000280, 0.00000261, 0.00000243, 0.00000227, 0.00000211, 0.00000197, 
            0.00000184, 0.00000171, 0.00000160, 0.00000149, 0.00000139, 0.00000129, 0.00000121, 0.00000112, 0.00000105, 0.00000098, 
            0.00000091, 0.00000085, 0.00000079, 0.00000074, 0.00000069, 0.00000064, 0.00000060, 0.00000056, 0.00000052, 0.00000048, 
            0.00000045
        };

        private static readonly double[] zvals = { 
            0.00060610, 0.00068088, 0.00076515, 0.00086001, 0.00096659, 0.00108600, 0.00122059, 0.00137273, 0.00154358, 0.00173429, 
            0.00194600, 0.00217778, 0.00243581, 0.00273195, 0.00307806, 0.00348600, 0.00397523, 0.00454088, 0.00515832, 0.00580291, 
            0.00645000, 0.00708322, 0.00774549, 0.00850115, 0.00941454, 0.01054999, 0.01196580, 0.01365587, 0.01558805, 0.01773015, 
            0.02005001, 0.02251136, 0.02520288, 0.02827972, 0.03189704, 0.03621000, 0.04143771, 0.04750372, 0.05411988, 0.06099803, 
            0.06785001, 0.07448632, 0.08136156, 0.08915364, 0.09854048, 0.11020000, 0.12461330, 0.14170170, 0.16130350, 0.18325680, 
            0.20740000, 0.23369210, 0.26261140, 0.29477460, 0.33079850, 0.37130000, 0.41620910, 0.46546420, 0.51969480, 0.57953030, 
            0.64560000, 0.71848380, 0.79671330, 0.87784590, 0.95943900, 1.03905010, 1.11536730, 1.18849710, 1.25812330, 1.32392960, 
            1.38560000, 1.44263520, 1.49480350, 1.54219030, 1.58488070, 1.62296000, 1.65640480, 1.68529590, 1.70987450, 1.73038210, 
            1.74706000, 1.76004460, 1.76962330, 1.77626370, 1.78043340, 1.78260000, 1.78296820, 1.78169980, 1.77919820, 1.77586710, 
            1.77211000, 1.76825890, 1.76403900, 1.75894380, 1.75246630, 1.74410000, 1.73355950, 1.72085810, 1.70593690, 1.68873720, 
            1.66920000, 1.64752870, 1.62341270, 1.59602230, 1.56452800, 1.52810000, 1.48611140, 1.43952150, 1.38987990, 1.33873620, 
            1.28764000, 1.23742230, 1.18782430, 1.13876110, 1.09014800, 1.04190000, 0.99419760, 0.94734730, 0.90145310, 0.85661930, 
            0.81295010, 0.77051730, 0.72944480, 0.68991360, 0.65210490, 0.61620000, 0.58232860, 0.55041620, 0.52033760, 0.49196730, 
            0.46518000, 0.43992460, 0.41618360, 0.39388220, 0.37294590, 0.35330000, 0.33485780, 0.31755210, 0.30133750, 0.28616860, 
            0.27200000, 0.25881710, 0.24648380, 0.23477180, 0.22345330, 0.21230000, 0.20116920, 0.19011960, 0.17922540, 0.16856080, 
            0.15820000, 0.14813830, 0.13837580, 0.12899420, 0.12007510, 0.11170000, 0.10390480, 0.09666748, 0.08998272, 0.08384531, 
            0.07824999, 0.07320899, 0.06867816, 0.06456784, 0.06078835, 0.05725001, 0.05390435, 0.05074664, 0.04775276, 0.04489859, 
            0.04216000, 0.03950728, 0.03693564, 0.03445836, 0.03208872, 0.02984000, 0.02771181, 0.02569444, 0.02378716, 0.02198925, 
            0.02030000, 0.01871805, 0.01724036, 0.01586364, 0.01458461, 0.01340000, 0.01230723, 0.01130188, 0.01037792, 0.00952931, 
            0.00875000, 0.00803520, 0.00738160, 0.00678540, 0.00624280, 0.00575000, 0.00530360, 0.00489980, 0.00453420, 0.00420240, 
            0.00390000, 0.00362320, 0.00337060, 0.00314140, 0.00293480, 0.00275000, 0.00258520, 0.00243860, 0.00230940, 0.00219680, 
            0.00210000, 0.00201773, 0.00194820, 0.00188980, 0.00184093, 0.00180000, 0.00176627, 0.00173780, 0.00171120, 0.00168307, 
            0.00165000, 0.00161013, 0.00156440, 0.00151360, 0.00145853, 0.00140000, 0.00133667, 0.00127000, 0.00120500, 0.00114667, 
            0.00110000, 0.00106880, 0.00104940, 0.00103560, 0.00102120, 0.00100000, 0.00096864, 0.00092992, 0.00088688, 0.00084256, 
            0.00080000, 0.00076096, 0.00072368, 0.00068592, 0.00064544, 0.00060000, 0.00054787, 0.00049160, 0.00043540, 0.00038347, 
            0.00034000, 0.00030725, 0.00028316, 0.00026544, 0.00025181, 0.00024000, 0.00022955, 0.00022064, 0.00021196, 0.00020219, 
            0.00019000, 0.00017421, 0.00015564, 0.00013596, 0.00011685, 0.00010000, 0.00008613, 0.00007460, 0.00006500, 0.00005693, 
            0.00005000, 0.00004416, 0.00003948, 0.00003572, 0.00003264, 0.00003000, 0.00002765, 0.00002556, 0.00002364, 0.00002181, 
            0.00002000, 0.00001813, 0.00001620, 0.00001420, 0.00001213, 0.00001000, 0.00000773, 0.00000540, 0.00000320, 0.00000133 
        };

        private static double GetX(int wavelength)
        {
            wavelength = wavelength - 360;
            if (wavelength >= xvals.Length) {
                return 0D;
            }
            else
            {
                return xvals[wavelength] / 106.86547; // total x luminance
            }
        }

        private static double GetY(int wavelength)
        {
            wavelength = wavelength - 360;
            if (wavelength >= yvals.Length)
            {
                return 0D;
            }
            else
            {
                return yvals[wavelength] / 106.856917D; // total y luminance
            }
        }

        private static double GetZ(int wavelength)
        {
            wavelength = wavelength - 360;
            if (wavelength >= zvals.Length)
            {
                return 0D;
            }
            else
            {
                return zvals[wavelength] / 106.89225D; // total z luminance;
            }
        }

        //public static double GetR(int wavelength)
        //{
        //    // conversion matrix from XYZ to sR
        //    double rLin = 3.2406D * GetX(wavelength) - 1.5372D * GetY(wavelength) - 0.4986D * GetZ(wavelength);

        //    return cap(rLin);
        //}

        //public static double GetG(int wavelength)
        //{
        //    // conversion matrix from XYZ to sG
        //    double gLin = -0.9689D * GetX(wavelength) + 1.8758D * GetY(wavelength) + 0.0415D * GetZ(wavelength);

        //    return cap(gLin);
        //}

        //public static double GetB(int wavelength)
        //{
        //    // conversion matrix from XYZ to sB
        //    double bLin = 0.0557D * GetX(wavelength) - 0.2040D * GetY(wavelength) + 1.0570D * GetZ(wavelength);

        //    return cap(bLin);
        //}

        private static double cap(double val)
        {
            if (val <= 0.0031308)
            {
                return Math.Max(Math.Min(12.92D * val,1),0);
            }
            else
            {
                return Math.Min(1.055 * Math.Pow(val, 1D / 2.4D) - 0.055,1);
            }
        }

        public static double GetR(Func<int, double> spectrum)
        {
            double X = 0;
            double Y = 0;
            double Z = 0;
            for (int l = 360; l < 830; l++)
            {
                double power = spectrum(l);
                X += GetX(l) * power;
                Y += GetY(l) * power;
                Z += GetZ(l) * power;
            }

            double rLin = 3.2406D * X - 1.5372D * Y - 0.4986D * Z;

            return cap(rLin);
        }

        public static double GetG(Func<int, double> spectrum)
        {
            double X = 0;
            double Y = 0;
            double Z = 0;
            for (int l = 360; l < 830; l++)
            {
                double power = spectrum(l);
                X += GetX(l) * power;
                Y += GetY(l) * power;
                Z += GetZ(l) * power;
            }

            double gLin = -0.9689D * X + 1.8758D * Y + 0.0415D * Z;

            return cap(gLin);
        }

        public static double GetB(Func<int, double> spectrum)
        {
            double X = 0;
            double Y = 0;
            double Z = 0;
            for (int l = 360; l < 830; l++)
            {
                double power = spectrum(l);
                X += GetX(l) * power;
                Y += GetY(l) * power;
                Z += GetZ(l) * power;
            }

            double bLin = 0.0557D * X - 0.2040D * Y + 1.0570D * Z;

            return cap(bLin);
        }
    }
}
